{% extends "base_goods.html" %}
{% block title %}{% endblock %}
{% block head %}
{% endblock %}
{% block base %}
    <div class="search_bar clearfix">
		<a href="/" class="logo fl"><img src="/static/images/logo.png"></a>
		<div class="sub_page_name fl">|&nbsp;&nbsp;&nbsp;&nbsp;购物车</div>
		<div class="search_con fr">
			<input type="text" class="input_text fl" name="" placeholder="搜索商品">
			<input type="button" class="input_btn fr" name="" value="搜索">
		</div>
	</div>

	<div class="total_count">全部商品<em>{{ count }}</em>件</div>
	<ul class="cart_list_th clearfix">
		<li class="col01">商品名称</li>
		<li class="col02">商品单位</li>
		<li class="col03">商品价格</li>
		<li class="col04">数量</li>
		<li class="col05">小计</li>
		<li class="col06">操作</li>
	</ul>
    {% for cart in cart_list %}
    <ul class="cart_list_td clearfix">
		<li class="col01"><input type="checkbox" name="" checked></li>
		<li class="col02"><img src="/static/media/{{ cart.goods.gpic }}"></li>
		<li class="col03"><n>{{ cart.goods.gtitle }}</n><br><em>{{ cart.goods.gprice }}元/{{ cart.goods.gunit }}</em></li>
		<li class="col04">{{ cart.goods.gunit }}</li>
		<li class="col05">{{ cart.goods.gprice }}元</li>
		<li class="col06">
			<div class="num_add">
				<a href="javascript:;" class="minus fl">-</a>
				<input type="text" class="num_show fl" value="{{ cart.count }}">
                <a href="javascript:;" class="add fl">+</a>
			</div>
		</li>
		<li class="col07">0元</li>
		<li class="col08"><a href="/cart/dele/{{ cart.goods.id }}/">删除</a></li>
        <input type="hidden" value="{{ cart.goods.id }}">
	</ul>
    {% endfor %}

	<ul class="settlements">
		<li class="col01"><input type="checkbox" name="" checked=""></li>
		<li class="col02">全选</li>
		<li class="col03">合计(不含运费)：<span>¥</span><em>42.60</em><br>共计<b>{{ count }}</b>件商品</li>
		<li class="col04">
            <a href="/order/">去结算</a></li>
	</ul>
    <script>

        $(function () {

            //点去结算  更改a标签链接
            $('.settlements .col04').click(function(){
                var ids = "";
                $.each($('.cart_list_td :checked'),function (i,o) {
                    var $o = $(o);
                    ids += ($o.parent().parent().children("input").val() + "_")
                })
                ids=ids.substring(0,ids.length-1);
                console.log(ids)
                if (ids!=""){
                    $(".settlements .col04 a").prop("href","/order/"+ ids +"/");
                }else{
                    $(".settlements .col04 a").prop("href","javascript:alert('请选中至少一件商品')");
                }

            })

            //进入购物车页面  计算出总金额  总件数
            var sum = 0
            for (var i=0;i<$(".cart_list_td").length;i++){
                var price = parseFloat($(".cart_list_td .col05").eq(i).text().replace("元",""))
                var count = parseInt($(".cart_list_td .col06 .num_add input").eq(i).val())
                $(".cart_list_td .col07").eq(i).text((price*count)+"元")
                sum+=(price*count)
            }
            $(".settlements .col03 em").text(sum+"元")

            //件数更改  js更爱页面信息  ajax请求更改数据库信息
            $(".cart_list_td .col06 .num_add input").blur(function () {

                if(isNaN($(this).val())){
                    alert("请重新输入")
                }else{
                    $(this).parent().parent().next().text(parseInt($(this).val())*(parseFloat($(this).parent().parent().prev().text().replace("元",""))*100)/100+"元")
                    total_price()

                    console.log($(this).parent().parent().parent().children("input").val())

                    var id = $(this).parent().parent().parent().children("input").val()
                    var count = $(this).val()
                    var url = '/cart/edit/'+id + '_' + count + '/'
                    $.get(url)
                }
            })

            $(".cart_list_td .minus").click(function () {
                if(parseInt($(this).next().val())>0){
                    $(this).next().val(parseInt($(this).next().val())-1)
                    $(this).parent().parent().next().text(parseInt($(this).next().val())*(parseFloat($(this).parent().parent().prev().text().replace("元",""))*100)/100+"元")

                    var id = $(this).parent().parent().parent().children("input").val()
                    var count = $(this).next().val()
                    var url = '/cart/edit/'+id + '_' + count + '/'
                    $.get(url)
                }
            })

            $(".cart_list_td .add").click(function () {
                $(this).prev().val(parseInt($(this).prev().val())+1)
                $(this).parent().parent().next().text(parseInt($(this).prev().val())*(parseFloat($(this).parent().parent().prev().text().replace("元",""))*100)/100+"元")

                var id = $(this).parent().parent().parent().children("input").val()
                var count = $(this).prev().val()
                var url = '/cart/edit/'+id + '_' + count + '/'
                $.get(url)
            })

            $(".num_add a").click(total_price)

            $(".cart_list_td .col01 input").click(total_price)
            $(".cart_list_td .col01 input").click(total_count)

            function total_price() {
                var sum = 0
                for (var i=0;i<$(".cart_list_td").length;i++){
                    if($(".cart_list_td .col07").eq(i).prev().prev().prev().prev().prev().prev().children().is(':checked')){
                        sum += parseInt(parseFloat($(".cart_list_td .col07").eq(i).text().replace("元",""))*100)
                    }
                }
                sum /= 100
                $(".settlements .col03 em").text(sum+"元")
            }

            function total_count() {
                var count = 0
                $.each($(".cart_list_td .col01 input"),function (i,o) {
                    if(o.checked){
                        count++
                    }
                })
                $(".settlements .col03 b").text(count)
            }

            //全选 全消
            $(".settlements .col01 input").click(function () {
                if ($(".settlements .col01 input").is(':checked')){
                    $(":checkbox").prop("checked",true)
                    total_price()
                    $(".settlements .col03 b").text("{{ count }}")
                }else {
                    $(":checkbox").prop("checked",false)
                    $(".settlements .col03 em").text("0元")
                    $(".settlements .col03 b").text("0")
                }
            })

            //全部选中后  全选框checked
            $(':checkbox').click(function(){

                if($('.settlements .col01 input').is(':checked') && $(':checked').length==$(':checkbox').length){
                    $('.settlements .col01 input').prop('checked',true);
                }else if (!$('.settlements .col01 input').is(':checked') && $(':checked').length+1==$(':checkbox').length){
                    $('.settlements .col01 input').prop('checked',true);
                }
                else{
                    $('.settlements .col01 input').prop('checked',false)
                }
            })
        })

    </script>
{% endblock %}


